<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Liste des registres</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/client-config.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
      const token = new URLSearchParams(window.location.search).get('token')
      function getURLParameter(name) {
        const urlParams = new URLSearchParams(window.location.search)
        return urlParams.get(name)
      }

      window.onload = function () {
        const token = getURLParameter('token')
        if (!token) {
          window.location.href =
            window.config.LOGIN_URL +
            '?redirectTo=' +
            encodeURIComponent(window.location.href)
        }
      }
    </script>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto py-8">
      <div class="bg-white shadow-md rounded-lg">
        <div class="p-4">
          <h1 class="text-xl font-bold mb-4">Liste des registres</h1>
          <hr class="mb-4" />

          <!-- Date Range Filter Section -->
          <div class="mb-4 flex items-center">
            <label for="startDate" class="mr-2">Date début Enregistré:</label>
            <input
              type="date"
              id="startDate"
              class="border border-gray-300 rounded px-2 py-1 mr-4"
              onchange="filterByDate()"
            />
            <label for="endDate" class="mr-2">Date fin Enregistré:</label>
            <input
              type="date"
              id="endDate"
              class="border border-gray-300 rounded px-2 py-1 mr-4"
              onchange="filterByDate()"
            />
            <button
              class="border hover:bg-blue-700 hover:text-white font-bold py-2 px-4 rounded"
              onclick="resetDateFilter()"
            >
              Réinitialiser
            </button>
          </div>
          <hr class="mb-4" />

          <!-- Print Modal -->
          <div
            id="printModal"
            class="fixed inset-0 flex items-center justify-center bg-gray-900 bg-opacity-50 z-50 hidden"
          >
            <div class="bg-white rounded-lg shadow-lg p-6">
              <div id="modalContent" class="mb-4">
                <div
                  id="document"
                  class="max-w-4xl mx-auto bg-white p-10 border"
                >
                  <div class="grid grid-cols-[30%_70%] gap-6">
                    <div class="space-y-6">
                      <div>
                        <p>
                          Soratra n°:
                          <span id="soratra" class="font-bold"></span>
                        </p>
                        <p>
                          Natao ny:
                          <span id="nataoNy" class="font-bold"></span>
                        </p>
                      </div>
                      <div>
                        <h1 class="text-xl font-bold">FAHATERAHANA</h1>
                      </div>
                      <div>
                        <p class="font-bold">Anarana</p>
                        <p id="anarana" class="font-normal"></p>
                      </div>
                      <div>
                        <p class="font-bold">Fanampin'anarana</p>
                        <p id="fanampinAnarana" class="font-normal"></p>
                      </div>
                      <div>
                        <p class="font-bold">LFT</p>
                        <p id="lft" class="font-normal">----</p>
                      </div>
                      <div>
                        <p class="font-bold">Teraka ny</p>
                        <p id="dateOfBirth" class="font-normal">----</p>
                      </div>
                    </div>

                    <div>
                      <p
                        id="firstParagraph"
                        class="whitespace-pre-line text-justify"
                      ></p>
                      <br />
                      <p
                        id="secondParagraph"
                        class="whitespace-pre-line text-justify"
                      ></p>
                    </div>
                  </div>
                </div>
              </div>
              <div class="flex justify-end">
                <button
                  onclick="closePrintModal()"
                  class="bg-red-300 hover:bg-red-400 text-white py-2 px-4 rounded mr-2"
                >
                  Annuler
                </button>
                <button
                  onclick="generatePDF()"
                  class="bg-blue-500 hover:bg-blue-700 text-white py-2 px-4 rounded"
                >
                  Imprimer
                </button>
              </div>
            </div>
          </div>

          <!-- Table Section -->
          <table
            class="min-w-full table-auto border-collapse border border-gray-200"
          >
            <thead>
              <tr class="bg-gray-100">
                <th
                  class="px-4 py-2 border-gray-300 text-left cursor-pointer"
                  onclick="sortTable('nom')"
                >
                  Nom
                  <span
                    class="sort-icon inline-block ml-1 w-3 h-3"
                    id="sort-nom"
                    >&#8597;</span
                  >
                </th>
                <th
                  class="px-4 py-2 border-gray-300 text-left cursor-pointer"
                  onclick="sortTable('event')"
                >
                  Évènement
                  <span
                    class="sort-icon inline-block ml-1 w-3 h-3"
                    id="sort-event"
                    >&#8597;</span
                  >
                </th>
                <th
                  class="px-4 py-2 border-gray-300 text-left cursor-pointer"
                  onclick="sortTable('dateEvent')"
                >
                  Date de l'évènement
                  <span
                    class="sort-icon inline-block ml-1 w-3 h-3"
                    id="sort-dateEvent"
                    >&#8597;</span
                  >
                </th>
                <th
                  class="px-4 py-2 border-gray-300 text-left cursor-pointer"
                  onclick="sortTable('registered')"
                >
                  Enregistré
                  <span
                    class="sort-icon inline-block ml-1 w-3 h-3"
                    id="sort-registered"
                    >&#8597;</span
                  >
                </th>
                <th class="px-4 py-2 border-gray-300"></th>
              </tr>
            </thead>
            <tbody id="data-table">
              <!-- Dynamic rows will be injected here -->
            </tbody>
          </table>

          <!-- Pagination Controls -->
          <div class="flex justify-end mt-4 space-x-2">
            <div class="flex items-center">
              <label for="pageSize" class="mr-2">Ligne par page</label>
              <select
                id="pageSize"
                class="border border-gray-300 rounded px-2 py-1"
                onchange="changePageSize()"
              >
                <option value="10">10</option>
                <option value="20">20</option>
                <option value="50">50</option>
                <option value="100">100</option>
              </select>
            </div>

            <button
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-1 px-3 rounded-l"
              onclick="prevPage()"
            >
              Prec
            </button>
            <div id="pagination-numbers" class="flex items-center space-x-1">
              <!-- Pagination numbers will be generated here -->
            </div>
            <button
              class="bg-gray-300 hover:bg-gray-400 text-gray-800 py-1 px-3 rounded-r"
              onclick="nextPage()"
            >
              Suiv
            </button>
          </div>
        </div>
      </div>
    </div>

    <script>
      let currentPage = 1
      let rowsPerPage = 10
      let totalPages = 1
      let sortDirection = 'asc'
      let sortColumn = '' // 'desc' by default

      function timeAgo(date) {
        const seconds = Math.floor((new Date() - new Date(date)) / 1000)
        let interval = Math.floor(seconds / 31536000) // years
        if (interval > 1) return 'il y a ' + interval + ' ans'
        interval = Math.floor(seconds / 2592000) // months
        if (interval > 1) return 'il y a ' + interval + ' mois'
        interval = Math.floor(seconds / 86400) // days
        if (interval > 1) return 'il y a ' + interval + ' jours'
        interval = Math.floor(seconds / 3600) // hours
        if (interval > 1) return 'il y a ' + interval + ' heures'
        interval = Math.floor(seconds / 60) // minutes
        if (interval > 1) return 'il y a ' + interval + ' minutes'
        return seconds < 5 ? "a l'instant" : seconds + ' secondes'
      }

      const fetchEvents = async (variables) => {
        const query = `
          query(
            $userId: String
            $advancedSearchParameters: AdvancedSearchParametersInput!
            $count: Int
            $skip: Int
            $sort: String
            $sortColumn: String
            $sortBy: [SortBy!]
          ) {
            searchEvents(
              userId: $userId
              advancedSearchParameters: $advancedSearchParameters
              count: $count
              skip: $skip
              sort: $sort
              sortColumn: $sortColumn
              sortBy: $sortBy
            ) {
              totalItems
              results {
                id
                type
                registration {
                  createdAt
                }
                ... on BirthEventSearchSet {
                  dateOfBirth
                  childName {
                    firstNames
                    middleName
                    familyName
                    use
                  }
                }
                __typename
              }
            }
          }`

        const response = await fetch('/graphql', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({ query, variables })
        })

        if (!response.ok) {
          throw new Error('Something went wrong with the graphql request')
        }

        const data = await response.json()
        return data
      }

      const fetchBirthRegistrationForCertificate = async (variables) => {
        const query = `
            query fetchBirthRegistrationForCertificate($id: ID!) {
              fetchBirthRegistration(id: $id) {
                _fhirIDMap
                id
                child {
                  id
                  multipleBirth
                  identifier {
                    id
                    type
                    otherType
                  }
                  name {
                    use
                    firstNames
                    middleName
                    familyName
                  }
                  birthDate
                  gender
                }
                mother {
                  id
                  name {
                    use
                    firstNames
                    middleName
                    familyName
                  }
                  birthDate
                  maritalStatus
                  dateOfMarriage
                  educationalAttainment
                  nationality
                  occupation
                  detailsExist
                  reasonNotApplying
                  ageOfIndividualInYears
                  exactDateOfBirthUnknown
                  identifier {
                    id
                    type
                    otherType
                  }
                  address {
                    type
                    line
                    district
                    state
                    city
                    postalCode
                    country
                  }
                  telecom {
                    system
                    value
                  }
                }
                father {
                  id
                  name {
                    use
                    firstNames
                    middleName
                    familyName
                  }
                  birthDate
                  maritalStatus
                  dateOfMarriage
                  educationalAttainment
                  nationality
                  occupation
                  detailsExist
                  reasonNotApplying
                  ageOfIndividualInYears
                  exactDateOfBirthUnknown
                  identifier {
                    id
                    type
                    otherType
                  }
                  address {
                    type
                    line
                    district
                    state
                    city
                    postalCode
                    country
                  }
                  telecom {
                    system
                    value
                  }
                }
                informant {
                  id
                  relationship
                  otherRelationship
                  _fhirIDPatient
                  identifier {
                    id
                    type
                    otherType
                  }
                  name {
                    use
                    firstNames
                    middleName
                    familyName
                  }
                  nationality
                  occupation
                  birthDate
                  ageOfIndividualInYears
                  exactDateOfBirthUnknown
                  address {
                    type
                    line
                    district
                    state
                    city
                    postalCode
                    country
                  }
                }
                registration {
                  id
                  informantType
                  otherInformantType
                  contact
                  contactPhoneNumber
                  contactEmail
                  informantsSignature
                  informantsSignatureURI
                  status {
                    comments {
                      comment
                    }
                    type
                    timestamp
                    location {
                      name
                      alias
                    }
                    office {
                      name
                      alias
                      address {
                        district
                        state
                      }
                      partOf
                    }
                  }
                  trackingId
                  registrationNumber
                  mosipAid
                }
                attendantAtBirth
                weightAtBirth
                birthType
                questionnaire {
                  fieldId
                  value
                }
                eventLocation {
                  id
                  type
                  address {
                    line
                    district
                    state
                    city
                    postalCode
                    country
                  }
                }
                history {
                  date
                  action
                  regStatus
                  dhis2Notification
                  ipAddress
                  statusReason {
                    text
                  }
                  reason
                  otherReason
                  location {
                    id
                    name
                  }
                  office {
                    id
                    name
                    alias
                    address {
                      state
                      district
                    }
                  }
                  system {
                    name
                    type
                  }
                  user {
                    id
                    role {
                      _id
                      labels {
                        lang
                        label
                      }
                    }
                    systemRole
                    name {
                      firstNames
                      familyName
                      use
                    }
                    avatar {
                      data
                      type
                    }
                  }
                  signature {
                    data
                    type
                  }
                  comments {
                    user {
                      id
                      username
                      avatar {
                        data
                        type
                      }
                    }
                    comment
                    createdAt
                  }
                  input {
                    valueCode
                    valueId
                    value
                  }
                  output {
                    valueCode
                    valueId
                    value
                  }
                  certificates {
                    hasShowedVerifiedDocument
                    collector {
                      relationship
                      otherRelationship
                      name {
                        use
                        firstNames
                        familyName
                      }
                      telecom {
                        system
                        value
                        use
                      }
                    }
                  }
                  duplicateOf
                  potentialDuplicates
                }
              }
            }`

        const response = await fetch('/graphql', {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
            Authorization: `Bearer ${token}`
          },
          body: JSON.stringify({
            query,
            variables
          })
        })

        if (!response.ok) {
          throw new Error('Something went wrong with the graphql request')
        }

        const data = await response.json()
        return data
      }

      // Function to render table rows with pagination
      const renderTable = async () => {
        const startDate = document.getElementById('startDate').value
        const endDate = document.getElementById('endDate').value
        const variables = {
          advancedSearchParameters: {
            registrationStatuses: ['REGISTERED', 'CERTIFIED', 'ISSUED'],
            dateOfRegistrationStart: startDate,
            dateOfRegistrationEnd: endDate
          },
          count: rowsPerPage,
          skip: (currentPage - 1) * rowsPerPage,
          sort: sortDirection
        }

        const events = await fetchEvents(variables)

        totalPages = Math.ceil(
          events.data.searchEvents.totalItems / rowsPerPage
        )

        const tableBody = document.getElementById('data-table')
        tableBody.innerHTML = ''

        const start = (currentPage - 1) * rowsPerPage
        const end = start + rowsPerPage

        events.data.searchEvents.results.forEach((item) => {
          const row = document.createElement('tr')
          row.classList.add('bg-white', 'hover:bg-gray-50')

          row.innerHTML = `
          <td class="px-4 py-2 border-b border-gray-300 text-blue-600"> ${[
            item.childName[0].firstNames,
            item.childName[0].middleName,
            item.childName[0].familyName
          ]
            .join(' ')
            .trim()}</td>
          <td class="px-4 py-2 border-b border-gray-300">${item.type}</td>
          <td class="px-4 py-2 border-b border-gray-300">${timeAgo(
            item.dateOfBirth
          )}</td>
          <td class="px-4 py-2 border-b border-gray-300">${timeAgo(
            new Date(Number(item.registration.createdAt))
              .toISOString()
              .split('T')[0]
          )}</td>
          <td  class="px-4 py-2 border-b border-gray-300"><button class="bg-blue-500 hover:bg-blue-700 text-white py-1 px-4 rounded" onclick="openPrintModal('${
            item.id
          }')">Imprimer</button></td>
        `
          tableBody.appendChild(row)
        })
        renderPagination()
      }

      const nextPage = () => {
        if (currentPage < totalPages) {
          currentPage++
          renderTable()
        }
      }

      const prevPage = () => {
        if (currentPage > 1) {
          currentPage--
          renderTable()
        }
      }

      const openPrintModal = async (id) => {
        const person = await fetchBirthRegistrationForCertificate({ id })
        if (person.data.fetchBirthRegistration) {
          const modal = document.getElementById('printModal')
          modal.classList.remove('hidden')

          const safePerson = person.data.fetchBirthRegistration

          const printableData = {
            soratra: safePerson.registration.registrationNumber,
            nataoNy: '07 Desambra 2024',
            anarana: safePerson.child.name[0].familyName,
            fanampinAnarana: [
              safePerson.child.name[0].firstNames,
              safePerson.child.name[0].middleName
            ]
              .join(' ')
              .trim(),
            lft: '----',
            dateOfBirth: safePerson.child.birthDate,
            firstParagraph: `---Tamin'ny "andro" "volana" "taona" tamin'ny "ora" ora sy "minitra" minitra "Maraina/Tolakan-dro/Hariva/Alina", no teraka tao amin'ny "toerana nahaterahana", fokontany "fokontany", kaominina "Kaominina", distrika "Distrika" : "ANARANA" "Fanampin'anarana", "zazalahy/zazavavy", zanaki' "ANARAN'NY RAY" "Fanampin'anaran'ny Ray", teraka tamin'ny "andro" "volana" "taona" tao amin'ny "toerana nahaterahana", kaominina "Kaominina", monina ao amin'ny fokontany "Fokontany", kaominina "Kaominina", distrika "Distrika", "anton'asa", sy "ANARAN'NY RENY" "Fanampin'anaran'ny Reny", teraka tamin'ny "andro" "volana" "taona" tao amin'ny "toerana nahaterahana", Kaominina "Kaominina", monina ao amin'ny fokontany "fokontany", kaominina "Kaominina", distrika "Distrika", "anton'asa". ---`,
            secondParagraph: `---Nosoratana androany "andro" "volana" "taona" tamin'ny "ora" ora sy "minitra" minitra "maraina/tolakadro/hariva/alina", araka ny fanambarana nataon'i "ANARAN'NY MPANAO FANAMBARANA" "Fanampin'anaran'ny mpanao fanambarana", "momba ny mpanao fanambarana", teraka tamin'ny "andro" "volana" "taona" tao amin'ny "toerana nahaterahana", kaominina "Kaominina", monina ao amin'ny Fokontany", Kaominina "Kaominina", distrika "Distrika", "anton'asa", izay miara-manao sonia aminay "ANARANAN'NY MPIANDRAIKITRA FIAINKOHONANA" "Fanampin'anarana", Mpandraikitra ny fankohonana eto amin'ny Kaominina "Kaominina", rehefa novakiana tamin'ity soratra ity.---`
          }

          document.getElementById('soratra').textContent = printableData.soratra
          document.getElementById('nataoNy').textContent = printableData.nataoNy
          document.getElementById('anarana').textContent = printableData.anarana
          document.getElementById('dateOfBirth').textContent =
            printableData.dateOfBirth
          document.getElementById('fanampinAnarana').textContent =
            printableData.fanampinAnarana
          document.getElementById('firstParagraph').textContent =
            printableData.firstParagraph
          document.getElementById('secondParagraph').textContent =
            printableData.secondParagraph
        }
      }

      const closePrintModal = () => {
        const modal = document.getElementById('printModal')
        modal.classList.add('hidden')
      }

      const renderPagination = () => {
        const paginationNumbers = document.getElementById('pagination-numbers')
        paginationNumbers.innerHTML = ''

        for (let i = 1; i <= totalPages; i++) {
          const pageNumber = document.createElement('button')
          pageNumber.classList.add(
            'hover:bg-gray-300',
            'px-3',
            'py-1',
            'rounded'
          )
          if (i === currentPage)
            pageNumber.classList.add('bg-blue-500', 'text-white')

          pageNumber.innerText = i
          pageNumber.onclick = () => {
            currentPage = i
            renderTable()
          }

          paginationNumbers.appendChild(pageNumber)
        }
      }

      const changePageSize = () => {
        const pageSizeSelect = document.getElementById('pageSize')
        rowsPerPage = parseInt(pageSizeSelect.value)
        currentPage = 1
        renderTable()
      }

      const sortTable = (column) => {
        sortColumn = column
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc'
        updateSortIcons()
        renderTable()
      }

      const updateSortIcons = () => {
        document.getElementById('sort-nom').textContent =
          sortColumn === 'nom' ? (sortDirection === 'asc' ? '▲' : '▼') : '↕'
        document.getElementById('sort-event').textContent =
          sortColumn === 'event' ? (sortDirection === 'asc' ? '▲' : '▼') : '↕'
        document.getElementById('sort-dateEvent').textContent =
          sortColumn === 'dateEvent'
            ? sortDirection === 'asc'
              ? '▲'
              : '▼'
            : '↕'
        document.getElementById('sort-registered').textContent =
          sortColumn === 'registered'
            ? sortDirection === 'asc'
              ? '▲'
              : '▼'
            : '↕'
      }

      const filterByDate = () => {
        const startDate = document.getElementById('startDate').value
        const endDate = document.getElementById('endDate').value
        currentPage = 1
        renderTable()
      }

      const resetDateFilter = () => {
        document.getElementById('startDate').value = ''
        document.getElementById('endDate').value = ''
        currentPage = 1
        renderTable()
      }

      //Initial render
      renderTable()

      function generatePDF(filename) {
        const { jsPDF } = window.jspdf
        const element = document.getElementById('document')

        element.style.background = 'white'
        element.style.boxShadow = 'none'
        element.style.border = 'none'

        html2canvas(element).then((canvas) => {
          const imgData = canvas.toDataURL('image/png')
          const pdf = new jsPDF('p', 'pt', 'a4')

          // Add the image to the PDF with consistent margins
          const margin = 20 // 20 points margin on left and right
          const imgWidth = 595.28 - 2 * margin // A4 width (595.28 points) minus left and right margins
          const imgHeight = (canvas.height * imgWidth) / canvas.width

          // Add image with margin
          pdf.addImage(imgData, 'PNG', margin, 20, imgWidth, imgHeight) // 20 points top margin
          pdf.save(filename ?? 'registre.pdf')

          element.style.background = ''
          element.style.boxShadow = ''
          closePrintModal()
        })
      }
    </script>
  </body>
</html>
