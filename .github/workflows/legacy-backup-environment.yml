# This Source Code Form is subject to the terms of the Mozilla Public
# License, v. 2.0. If a copy of the MPL was not distributed with this
# file, You can obtain one at https://mozilla.org/MPL/2.0/.
#
# OpenCRVS is also distributed under the terms of the Civil Registration
# & Healthcare Disclaimer located at http://opencrvs.org/license.
#
# Copyright (C) The OpenCRVS Authors located at https://github.com/opencrvs/opencrvs-core/blob/master/AUTHORS.
name: Backup from legacy environment

on:
  workflow_dispatch:
    inputs:
      environment:
        type: choice
        description: Environment to create backup from
        required: true
        default: legacy-preprod
        options:
          - legacy-preprod
      environment_to_backup:
        type: choice
        description: Environment to create backups to
        required: true
        default: qa
        options:
          - qa
      replicas:
        description: No of replicas deployed in the environment
        default: '1'
        required: true
      version_label:
        description: The version label for the backups
        required: true
jobs:
  server-to-backup-vars:
    environment: ${{ github.event.inputs.environment_to_backup }}
    runs-on: ubuntu-22.04
    outputs:
      BACKUP_SSH_HOST: ${{ vars.SSH_HOST || secrets.SSH_HOST }}
      BACKUP_SSH_PORT: ${{ vars.SSH_PORT || secrets.SSH_PORT }}
      BACKUP_SSH_USER: ${{ secrets.SSH_USER }}

  run-backup:
    environment: ${{ github.event.inputs.environment }}
    needs: server-to-backup-vars
    runs-on: ubuntu-22.04
    steps:
      - name: Install SSH Key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_KEY }}
          known_hosts: ${{ secrets.KNOWN_HOSTS }}
      - name: Create backup data in given environment and copy it over to the backup environment
        - env:
          BACKUP_SSH_HOST: ${{ needs.server-to-backup-vars.outputs.BACKUP_SSH_HOST }}
          BACKUP_SSH_PORT: ${{ needs.server-to-backup-vars.outputs.BACKUP_SSH_PORT }}
          BACKUP_SSH_USER: ${{ needs.server-to-backup-vars.outputs.BACKUP_SSH_USER }}
        run: |
  ssh $BACKUP_SSH_USER@$BACKUP_SSH_HOST -p $BACKUP_SSH_PORT "\
        bash infrastructure/backup.sh \
          --ssh_host=${{ vars.SSH_HOST || secrets.SSH_HOST }} \
          --ssh_port=${{ vars.SSH_PORT || secrets.SSH_PORT }} \
          --ssh_user=${{ secrets.SSH_USER }} \
          --remote_dir=/data/backup \
          --replicas=1 >> /var/log/opencrvs-backup.log 2>&1"
